<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KnowlEdge ç®¡ç†å‘˜åå°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%); background-attachment: fixed; }
    .nav-glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .glass-card { background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.12); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
    .glass-input { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; color: white; padding: 12px 14px; width: 100%; font-size: 14px; transition: all .3s ease; }
    .glass-input::placeholder { color: rgba(255,255,255,0.6); }
    .primary-btn { background: linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%); border: none; border-radius: 12px; color: white; padding: 10px 14px; font-weight: 600; transition: all .3s ease; }
    .primary-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(102,126,234,.35); }
    .badge { background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; padding:2px 8px; border-radius: 999px; font-size: 12px; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px; color: #e2e8f0; text-align: left; }
    .table th { color: #fff; font-weight: 600; background: rgba(102,126,234,0.15); }
  </style>
</head>
<body>
  <nav class="nav-glass p-4 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
          <i class="fas fa-shield-alt text-white text-lg"></i>
        </div>
        <h1 class="text-2xl font-bold text-white">ç®¡ç†å‘˜åå°</h1>
      </div>
      <div class="text-white/80 text-sm flex items-center space-x-4">
        <span id="adminStatus" class="text-white/60 text-xs"></span>
        <button id="fixDbBtn" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">
          <i class="fas fa-wrench mr-1"></i>ä¿®å¤DB
        </button>
        <a href="/" class="hover:text-white">è¿”å›é¦–é¡µ</a>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="glass-card p-4 text-center">
        <div class="text-blue-400 text-2xl font-bold" id="totalUsers">-</div>
        <div class="text-white/70 text-sm">æ€»ç”¨æˆ·æ•°</div>
      </div>
      <div class="glass-card p-4 text-center">
        <div class="text-green-400 text-2xl font-bold" id="totalAdmins">-</div>
        <div class="text-white/70 text-sm">ç®¡ç†å‘˜æ•°</div>
      </div>
      <div class="glass-card p-4 text-center">
        <div class="text-yellow-400 text-2xl font-bold" id="totalSearches">-</div>
        <div class="text-white/70 text-sm">æ€»æœç´¢æ¬¡æ•°</div>
      </div>
      <div class="glass-card p-4 text-center">
        <div class="text-purple-400 text-2xl font-bold" id="totalInteractions">-</div>
        <div class="text-white/70 text-sm">æ€»äº¤äº’æ¬¡æ•°</div>
      </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- å·¦ä¾§ï¼šç”¨æˆ·åˆ—è¡¨ -->
      <div class="lg:col-span-1 glass-card p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-white text-lg font-semibold"><i class="fas fa-users mr-2 text-blue-400"></i> ç”¨æˆ·åˆ—è¡¨</h2>
          <div class="flex space-x-2">
            <button id="refreshBtn" class="primary-btn px-3 py-1 text-xs"><i class="fas fa-sync-alt"></i></button>
            <button id="exportBtn" class="primary-btn px-3 py-1 text-xs"><i class="fas fa-download"></i></button>
          </div>
        </div>
        <div class="mb-4 flex space-x-2">
          <input id="q" class="glass-input" placeholder="æœç´¢ç”¨æˆ·ID/å§“å/é‚®ç®±" />
          <button id="searchBtn" class="primary-btn"><i class="fas fa-search"></i></button>
        </div>
        <div id="usersPanel" class="overflow-auto max-h-[70vh]">
          <table class="table text-sm">
            <thead>
              <tr><th>ID</th><th>å§“å</th><th>å…´è¶£</th><th>æŠ€èƒ½</th><th>æœç´¢</th></tr>
            </thead>
            <tbody id="usersBody"></tbody>
          </table>
        </div>
      </div>
      <!-- å³ä¾§ï¼šè¯¦æƒ… -->
      <div class="lg:col-span-2 glass-card p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-white text-lg font-semibold"><i class="fas fa-id-card mr-2 text-purple-400"></i> ç”¨æˆ·è¯¦æƒ…</h2>
          <div class="flex items-center space-x-2">
            <div id="currentUserId" class="badge">æœªé€‰æ‹©</div>
            <button id="deleteUserBtn" class="hidden bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
              <i class="fas fa-trash mr-1"></i>åˆ é™¤ç”¨æˆ·
            </button>
          </div>
        </div>
        <div id="detailPanel" class="space-y-6">
          <div class="glass-card p-4">
            <h3 class="text-white font-semibold mb-2">åŸºæœ¬ä¿¡æ¯</h3>
            <div id="basicInfo" class="text-white/80 text-sm">è¯·é€‰æ‹©å·¦ä¾§ç”¨æˆ·æŸ¥çœ‹è¯¦æƒ…</div>
            <div class="mt-3 hidden" id="adminToggleRow">
              <label class="text-white/80 text-sm mr-2">ç®¡ç†å‘˜</label>
              <input id="adminToggle" type="checkbox" />
              <button id="saveRoleBtn" class="ml-3 primary-btn px-3 py-1">ä¿å­˜</button>
            </div>
          </div>
          <div class="glass-card p-4">
            <h3 class="text-white font-semibold mb-2">å…´è¶£ï¼ˆæŒ‰æƒé‡ï¼‰</h3>
            <div id="interests" class="text-white/80 text-sm"></div>
          </div>
          <div class="glass-card p-4">
            <h3 class="text-white font-semibold mb-2">æŠ€èƒ½</h3>
            <div id="skills" class="text-white/80 text-sm"></div>
          </div>
          <div class="glass-card p-4">
            <h3 class="text-white font-semibold mb-2">æ•™è‚²ç»å†</h3>
            <div id="education" class="text-white/80 text-sm"></div>
          </div>
          <div class="glass-card p-4">
            <h3 class="text-white font-semibold mb-2">å·¥ä½œç»å†</h3>
            <div id="work" class="text-white/80 text-sm"></div>
          </div>
          <div class="glass-card p-4">
            <h3 class="text-white font-semibold mb-2">æœ€è¿‘æœç´¢</h3>
            <div id="searches" class="text-white/80 text-sm"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const usersBody = document.getElementById('usersBody');
    const currentUserIdEl = document.getElementById('currentUserId');
    const qInput = document.getElementById('q');

    function htmlesc(s){ return (s ?? '').toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    async function fetchUsers(){
      const q = encodeURIComponent(qInput.value || '');
      try {
        const resp = await fetch(`/api/admin/users?q=${q}`);
        if (!resp.ok) { 
          const errorText = await resp.text();
          console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', resp.status, errorText);
          usersBody.innerHTML = `<tr><td colspan="5" class="text-red-400">åŠ è½½å¤±è´¥: ${resp.status}</td></tr>`; 
          return; 
        }
        const data = await resp.json();
        console.log('ç”¨æˆ·æ•°æ®:', data);
        const rows = (data.items || []).map(u=>{
          const name = htmlesc(u.name || u.id);
          const admin = u.is_admin ? ' <i class=\'fas fa-shield-alt text-yellow-400\' title=\'ç®¡ç†å‘˜\'></i>' : '';
          return `<tr class="hover:bg-white/5 cursor-pointer" data-uid="${htmlesc(u.id)}">
            <td class="text-xs">${htmlesc(u.id)}</td>
            <td>${name}${admin}</td>
            <td><span class="badge">${u.counts?.interests ?? 0}</span></td>
            <td><span class="badge">${u.counts?.skills ?? 0}</span></td>
            <td><span class="badge">${u.counts?.searches ?? 0}</span></td>
          </tr>`;
        }).join('');
        usersBody.innerHTML = rows || `<tr><td colspan="5" class="text-white/70">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>`;
        document.querySelectorAll('[data-uid]')?.forEach(tr=>{
          tr.onclick = ()=> loadDetail(tr.getAttribute('data-uid'));
        });
      } catch(e) {
        console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¼‚å¸¸:', e);
        usersBody.innerHTML = `<tr><td colspan="5" class="text-red-400">ç½‘ç»œé”™è¯¯</td></tr>`;
      }
    }

    async function loadDetail(userId){
      currentUserIdEl.textContent = userId;
      try {
        const resp = await fetch(`/api/admin/users/${encodeURIComponent(userId)}`);
        if (!resp.ok) { 
          console.error('è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', resp.status);
          if (resp.status === 500) {
            setDetailError(`æ•°æ®åº“é”™è¯¯ (${resp.status})ï¼Œè¯·ç‚¹å‡»é¡¶éƒ¨"ä¿®å¤DB"æŒ‰é’®ä¿®å¤æ•°æ®åº“`); 
          } else {
            setDetailError(`åŠ è½½è¯¦æƒ…å¤±è´¥: ${resp.status}`); 
          }
          return; 
        }
        const d = await resp.json();
        console.log('ç”¨æˆ·è¯¦æƒ…:', d);
        
        // ç®¡ç†å‘˜æƒé™æ§åˆ¶
        const toggleRow = document.getElementById('adminToggleRow');
        const toggle = document.getElementById('adminToggle');
        const saveBtn = document.getElementById('saveRoleBtn');
        const deleteBtn = document.getElementById('deleteUserBtn');
        
        toggleRow.classList.remove('hidden');
        deleteBtn.classList.remove('hidden');
        toggle.checked = !!d.user?.is_admin;
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®
        deleteBtn.onclick = () => deleteUser(userId);
        saveBtn.onclick = async ()=>{
          try{
            const r = await fetch(`/api/admin/users/${encodeURIComponent(userId)}/role`, { 
              method:'POST', 
              headers:{'Content-Type':'application/json'}, 
              body: JSON.stringify({ is_admin: toggle.checked }) 
            });
            if (!r.ok) throw new Error('ä¿å­˜å¤±è´¥');
            alert('æƒé™æ›´æ–°æˆåŠŸ');
            await loadDetail(userId);
            // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨ä»¥æ›´æ–°ç®¡ç†å‘˜æ ‡è¯†
            await fetchUsers();
          }catch(e){ 
            console.error('ä¿å­˜æƒé™å¤±è´¥:', e);
            alert('ä¿å­˜å¤±è´¥: ' + e.message); 
          }
        };
        
        // åŸºæœ¬ä¿¡æ¯
        setBasic(d.user);
        
        // æ˜¾ç¤ºç”»åƒæ¦‚è¦ï¼ˆè‹¥æœ‰ï¼‰
        const basic = document.getElementById('basicInfo');
        if (d.profile && d.profile.profile){
          const p = d.profile.profile;
          const extras = [];
          if (p.keywords) extras.push(`<div>å…³é”®è¯ï¼š<span class='text-white'>${htmlesc(p.keywords.join?.(', ') || '')}</span></div>`);
          if (p.research_interests) extras.push(`<div>ç ”ç©¶å…´è¶£ï¼š<span class='text-white'>${htmlesc(p.research_interests.join?.(', ') || '')}</span></div>`);
          if (extras.length) basic.insertAdjacentHTML('beforeend', `<div class='mt-2 space-y-1 border-t border-white/10 pt-2'>${extras.join('')}</div>`);
        }
        
        // è¯¦ç»†æ•°æ®
        setList('interests', d.interests, x=> `${htmlesc(x.topic)} <span class="badge ml-2">æƒé‡: ${x.weight?.toFixed?.(2) ?? x.weight ?? '0'}</span> <span class="text-white/50 ml-2">${htmlesc(x.category||'')}</span> ${x.reason ? `<div class="text-white/60 text-sm mt-1">åŸå› : ${htmlesc(x.reason)}</div>` : ''} <span class="text-xs text-white/40 ml-2">${htmlesc(x.last_updated?.split('T')[0] || '')}</span>`);
        setList('skills', d.skills, x=> `${htmlesc(x.skill)} <span class="text-white/50 ml-2">ç­‰çº§: ${htmlesc(x.level||'')}</span> <span class="text-white/50 ml-2">ç±»åˆ«: ${htmlesc(x.category||'')}</span>`);
        setList('education', d.education, x=> `${htmlesc(x.institution||'æœªçŸ¥')} Â· ${htmlesc(x.major||'')} Â· ${htmlesc(x.degree||'')} <span class="text-white/50 ml-2">${htmlesc(x.time_period||'')}</span>`);
        setList('work', d.work, x=> `${htmlesc(x.company||'æœªçŸ¥')} Â· ${htmlesc(x.position||'')} <span class="text-white/50 ml-2">${htmlesc(x.time_period||'')}</span>${x.description ? `<div class="text-white/60 text-sm mt-1">${htmlesc(x.description)}</div>` : ''}`);
        setList('searches', d.recent_searches, x=> `<span class="text-white/50">${htmlesc(x.timestamp?.split('T')[0] || x.timestamp || '')}</span> Â· <span class="badge">${htmlesc(x.platform||'')}</span> Â· ${htmlesc(x.query||'')}`);
        
      } catch(e) {
        console.error('åŠ è½½ç”¨æˆ·è¯¦æƒ…å¼‚å¸¸:', e);
        setDetailError('ç½‘ç»œé”™è¯¯: ' + e.message);
      }
    }

    function setDetailError(msg){
      document.getElementById('basicInfo').innerHTML = `<span class="text-red-400">${htmlesc(msg)}</span>`;
      ['interests','skills','education','work','searches'].forEach(id=> document.getElementById(id).innerHTML='');
    }

    function setBasic(u){
      const dom = document.getElementById('basicInfo');
      if (!u){ dom.textContent = 'æœªæ‰¾åˆ°'; return; }
      dom.innerHTML = `
        <div>ç”¨æˆ·IDï¼š<span class="text-white">${htmlesc(u.id)}</span></div>
        <div>å§“åï¼š<span class="text-white">${htmlesc(u.name||'')}</span></div>
        <div>èŒä¸šï¼š<span class="text-white">${htmlesc(u.occupation||'')}</span></div>
        <div>é‚®ç®±ï¼š<span class="text-white">${htmlesc(u.email||'')}</span></div>
        <div>åˆ›å»ºæ—¶é—´ï¼š<span class="text-white">${htmlesc(u.created_at||'')}</span></div>
        ${u.updated_at ? `<div>æ›´æ–°æ—¶é—´ï¼š<span class="text-white">${htmlesc(u.updated_at)}</span></div>` : '<div class="text-yellow-400 text-sm">âš ï¸ æ›´æ–°æ—¶é—´å­—æ®µç¼ºå¤±ï¼Œç‚¹å‡»"ä¿®å¤DB"æŒ‰é’®ä¿®å¤</div>'}
      `;
    }

    function setList(id, arr, render){
      const el = document.getElementById(id);
      if (!arr || !arr.length){ el.innerHTML = '<span class="text-white/60">æ— </span>'; return; }
      el.innerHTML = `<ul class="list-disc ml-5 space-y-1">${arr.map(render).map(x=>`<li>${x}</li>`).join('')}</ul>`;
    }

    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    async function loadStats() {
      try {
        // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸“é—¨çš„ç»Ÿè®¡APIï¼Œç°åœ¨å…ˆç”¨ç”¨æˆ·åˆ—è¡¨æ•°æ®ä¼°ç®—
        const resp = await fetch('/api/admin/users?limit=1000');
        if (resp.ok) {
          const data = await resp.json();
          const users = data.items || [];
          
          document.getElementById('totalUsers').textContent = users.length;
          document.getElementById('totalAdmins').textContent = users.filter(u => u.is_admin).length;
          
          // è®¡ç®—æ€»æœç´¢å’Œäº¤äº’æ¬¡æ•°
          let totalSearches = 0;
          let totalInteractions = 0;
          users.forEach(u => {
            totalSearches += u.counts?.searches || 0;
            totalInteractions += u.counts?.interactions || 0;
          });
          
          document.getElementById('totalSearches').textContent = totalSearches;
          document.getElementById('totalInteractions').textContent = totalInteractions;
        }
      } catch(e) {
        console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', e);
      }
    }
    
    // åˆ·æ–°åŠŸèƒ½
    async function refreshAll() {
      document.getElementById('adminStatus').textContent = 'åˆ·æ–°ä¸­...';
      try {
        await Promise.all([fetchUsers(), loadStats()]);
        document.getElementById('adminStatus').textContent = 'åˆ·æ–°å®Œæˆ';
        setTimeout(() => {
          document.getElementById('adminStatus').textContent = 'ç®¡ç†å‘˜åå°å·²å°±ç»ª';
        }, 2000);
      } catch(e) {
        document.getElementById('adminStatus').textContent = 'åˆ·æ–°å¤±è´¥';
      }
    }
    
    // å¯¼å‡ºåŠŸèƒ½
    function exportData() {
      const csvContent = "data:text/csv;charset=utf-8," 
        + "ç”¨æˆ·ID,å§“å,èŒä¸š,é‚®ç®±,åˆ›å»ºæ—¶é—´,æ˜¯å¦ç®¡ç†å‘˜\n"
        + Array.from(document.querySelectorAll('[data-uid]')).map(row => {
            const cells = row.querySelectorAll('td');
            return [
              cells[0]?.textContent || '',
              cells[1]?.textContent?.replace(/ğŸ‘‘/g, '') || '',
              '', // èŒä¸šä¿¡æ¯éœ€è¦ä»è¯¦æƒ…è·å–
              '', // é‚®ç®±ä¿¡æ¯éœ€è¦ä»è¯¦æƒ…è·å–
              '', // åˆ›å»ºæ—¶é—´éœ€è¦ä»è¯¦æƒ…è·å–
              cells[1]?.innerHTML?.includes('fa-shield-alt') ? 'æ˜¯' : 'å¦'
            ].map(field => `"${field}"`).join(',');
          }).join('\n');
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `users_export_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // åˆ é™¤ç”¨æˆ·åŠŸèƒ½
    async function deleteUser(userId) {
      if (!confirm(`ç¡®è®¤åˆ é™¤ç”¨æˆ· ${userId}ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
        return;
      }
      
      try {
        const resp = await fetch(`/api/admin/users/${encodeURIComponent(userId)}`, {
          method: 'DELETE'
        });
        
        if (resp.ok) {
          alert('ç”¨æˆ·åˆ é™¤æˆåŠŸ');
          await fetchUsers();
          // æ¸…ç©ºè¯¦æƒ…é¢æ¿
          document.getElementById('currentUserId').textContent = 'æœªé€‰æ‹©';
          document.getElementById('deleteUserBtn').classList.add('hidden');
          document.getElementById('adminToggleRow').classList.add('hidden');
          ['basicInfo','interests','skills','education','work','searches'].forEach(id => {
            document.getElementById(id).innerHTML = 'è¯·é€‰æ‹©å·¦ä¾§ç”¨æˆ·æŸ¥çœ‹è¯¦æƒ…';
          });
        } else {
          const error = await resp.text();
          alert('åˆ é™¤å¤±è´¥: ' + error);
        }
      } catch(e) {
        alert('åˆ é™¤å¤±è´¥: ' + e.message);
      }
    }
    
    // æ•°æ®åº“ä¿®å¤åŠŸèƒ½
    async function fixDatabase() {
      if (!confirm('ç¡®è®¤ä¿®å¤æ•°æ®åº“ï¼Ÿè¿™å°†æ·»åŠ ç¼ºå¤±çš„åˆ—åˆ°æ•°æ®åº“è¡¨ä¸­ã€‚')) {
        return;
      }
      
      const btn = document.getElementById('fixDbBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ä¿®å¤ä¸­';
      btn.disabled = true;
      
      try {
        const resp = await fetch('/api/admin/fix_database', {
          method: 'POST'
        });
        
        if (resp.ok) {
          const result = await resp.json();
          alert(result.message);
          if (result.fixes && result.fixes.length > 0) {
            // å¦‚æœæœ‰ä¿®å¤ï¼Œåˆ·æ–°é¡µé¢æ•°æ®
            await refreshAll();
          }
        } else {
          const error = await resp.json();
          alert('ä¿®å¤å¤±è´¥: ' + error.error);
        }
      } catch(e) {
        alert('ä¿®å¤å¤±è´¥: ' + e.message);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
    
    // åˆå§‹åŒ–äº‹ä»¶ç»‘å®š
    document.getElementById('searchBtn').onclick = fetchUsers;
    document.getElementById('refreshBtn').onclick = refreshAll;
    document.getElementById('exportBtn').onclick = exportData;
    document.getElementById('fixDbBtn').onclick = fixDatabase;
    qInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); fetchUsers(); }});
    
    // æ˜¾ç¤ºç®¡ç†å‘˜çŠ¶æ€
    document.getElementById('adminStatus').textContent = 'æ­£åœ¨åŠ è½½...';
    
    // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
    async function checkDatabaseStatus() {
      try {
        // å°è¯•è·å–ä¸€ä¸ªç”¨æˆ·è¯¦æƒ…æ¥æµ‹è¯•æ•°æ®åº“
        const resp = await fetch('/api/admin/users?limit=1');
        if (resp.ok) {
          const data = await resp.json();
          if (data.items && data.items.length > 0) {
            // å°è¯•è·å–ç¬¬ä¸€ä¸ªç”¨æˆ·çš„è¯¦æƒ…
            const firstUser = data.items[0];
            const detailResp = await fetch(`/api/admin/users/${encodeURIComponent(firstUser.id)}`);
            if (!detailResp.ok && detailResp.status === 500) {
              document.getElementById('adminStatus').innerHTML = 
                '<span class="text-red-400">âš ï¸ æ•°æ®åº“éœ€è¦ä¿®å¤ï¼Œè¯·ç‚¹å‡»"ä¿®å¤DB"</span>';
              return false;
            }
          }
        }
        return true;
      } catch(e) {
        console.error('æ•°æ®åº“çŠ¶æ€æ£€æŸ¥å¤±è´¥:', e);
        return false;
      }
    }
    
    // å¯åŠ¨æ—¶è·å–æ•°æ®
    Promise.all([fetchUsers(), loadStats()]).then(async () => {
      const dbOk = await checkDatabaseStatus();
      if (dbOk) {
        document.getElementById('adminStatus').textContent = 'ç®¡ç†å‘˜åå°å·²å°±ç»ª';
      }
    }).catch(e => {
      document.getElementById('adminStatus').textContent = 'åŠ è½½å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ä¿®å¤æ•°æ®åº“';
      console.error('åˆå§‹åŒ–å¤±è´¥:', e);
    });
  </script>
</body>
</html> 