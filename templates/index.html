<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KnowlEdge 个性化知识引擎</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Markdown 渲染 & Mermaid 流程图 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  
  <!-- 字体和图标 -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    * {
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
      background-attachment: fixed;
      position: relative;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    
    .glass-input {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      color: white;
      padding: 14px 16px;
      width: 100%;
      font-size: 15px;
      transition: all 0.3s ease;
    }
    
    .glass-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(139, 92, 246, 0.5);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
      transform: translateY(-2px);
    }
    
    .glass-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .glass-select {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      color: white;
      padding: 14px 16px;
      width: 100%;
      font-size: 15px;
      appearance: none;
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 12px center;
      background-repeat: no-repeat;
      background-size: 16px;
      transition: all 0.3s ease;
    }
    
    .glass-select:focus {
      outline: none;
      background-color: rgba(255, 255, 255, 0.15);
      border-color: rgba(139, 92, 246, 0.5);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
      transform: translateY(-2px);
    }
    
    .glass-select option {
      background: #1a1a2e;
      color: white;
    }
    
    .generate-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      padding: 18px 32px;
      width: 100%;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .generate-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
    }
    
    .generate-btn:active {
      transform: translateY(-1px);
    }
    
    .generate-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .generate-btn:hover::before {
      left: 100%;
    }
    
    .floating-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(40px);
      animation: float 6s ease-in-out infinite;
      pointer-events: none;
    }
    
    .floating-orb:nth-child(1) {
      width: 300px;
      height: 300px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }
    
    .floating-orb:nth-child(2) {
      width: 200px;
      height: 200px;
      background: linear-gradient(45deg, #f093fb, #f5576c);
      top: 60%;
      right: 10%;
      animation-delay: -2s;
    }
    
    .floating-orb:nth-child(3) {
      width: 250px;
      height: 250px;
      background: linear-gradient(45deg, #4facfe, #00f2fe);
      bottom: 20%;
      left: 50%;
      animation-delay: -4s;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) scale(1); opacity: 0.7; }
      50% { transform: translateY(-30px) scale(1.1); opacity: 0.9; }
    }
    
    .progress-modal {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }
    
    .progress-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(30px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    
    .report-content {
      color: white;
      line-height: 1.8;
      font-size: 16px;
    }
    
    .report-content h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: #f8fafc;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 3px solid #667eea;
      background: linear-gradient(135deg, #667eea, #764ba2);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .report-content h2 {
      font-size: 2rem;
      font-weight: 600;
      color: #e2e8f0;
      margin-top: 2rem;
      margin-bottom: 1rem;
      padding-left: 1rem;
      border-left: 4px solid #667eea;
    }
    
    .report-content h3 {
      font-size: 1.5rem;
      font-weight: 500;
      color: #cbd5e1;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
    }
    
    .report-content p {
      color: #e2e8f0;
      margin-bottom: 1rem;
      text-align: justify;
    }
    
    .report-content ul, .report-content ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .report-content li {
      color: #e2e8f0;
      margin-bottom: 0.5rem;
    }
    
    .report-content blockquote {
      border-left: 4px solid #667eea;
      padding-left: 1rem;
      font-style: italic;
      background: rgba(102, 126, 234, 0.1);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 8px 8px 0;
      color: #cbd5e1;
    }
    
    .report-content code {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #fbbf24;
    }
    
    .report-content pre {
      background: rgba(0, 0, 0, 0.6);
      color: #10b981;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1rem 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .report-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .report-content th, .report-content td {
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem;
      text-align: left;
    }
    
    .report-content th {
      background: rgba(102, 126, 234, 0.2);
      font-weight: 600;
      color: white;
    }
    
    .report-content td {
      color: #e2e8f0;
    }
    
    .nav-glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .typewriter {
      overflow: hidden;
      white-space: pre-wrap;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      background: rgba(16, 185, 129, 0.9);
    }
    
    .toast.error {
      background: rgba(239, 68, 68, 0.9);
    }
    
    .fade-in {
      animation: fadeIn 0.8s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .spin {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'inter': ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen">
  <!-- 浮动装饰球体 -->
  <div class="floating-orb"></div>
  <div class="floating-orb"></div>
  <div class="floating-orb"></div>

  <!-- 顶部导航 -->
  <nav class="nav-glass p-4 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
          <i class="fas fa-brain text-white text-lg"></i>
        </div>
        <h1 class="text-2xl font-bold text-white">KnowlEdge</h1>
      </div>
      <div class="text-white/70 text-sm flex items-center space-x-4">
        <span id="guestBadge" class="hidden px-2 py-1 rounded bg-white/10 text-white/80 text-xs">游客模式</span>
        <span id="userNameLabel" class="hidden text-white/90"></span>
        <i id="adminBadge" class="hidden fas fa-shield-alt text-yellow-400" title="管理员"></i>
        <a id="authLink" href="/auth" class="hover:text-white">登录/注册</a>
        <a id="adminEntry" href="/admin" class="hidden hover:text-white">管理后台</a>
        <button id="logoutBtn" class="hidden hover:text-white">退出登录</button>
      </div>
    </div>
  </nav>

  <!-- 主内容区域 -->
  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- 表单卡片 -->
    <div class="glass-card p-8 mb-8 fade-in">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-6 pulse">
          <i class="fas fa-magic text-3xl text-white"></i>
        </div>
        <h2 class="text-3xl font-bold text-white mb-3">AI知识报告生成器</h2>
        <p class="text-white/70 text-lg">输入您的需求，获得专业的个性化知识报告</p>
      </div>

      <form id="knowledgeForm" class="space-y-6">
        <!-- 基本信息行 -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-white/80 text-sm font-medium mb-2">职业领域（选填）</label>
            <input name="occupation" placeholder="如：软件工程师、研究员等（选填）" class="glass-input" />
          </div>
          <div>
            <label class="block text-white/80 text-sm font-medium mb-2">邮箱（选填）</label>
            <input name="email" type="email" placeholder="用于后续知识更新（选填）" class="glass-input" />
          </div>
        </div>

        <!-- 关注领域 -->
        <div>
          <label class="block text-white/80 text-sm font-medium mb-2">研究关注领域</label>
          <input name="content_type" placeholder="请输入您感兴趣的领域，如：自然语言处理、机器学习、深度学习等" class="glass-input" required />
        </div>

        <!-- 报告类型 -->
        <div>
          <label class="block text-white/80 text-sm font-medium mb-2">报告类型</label>
          <select name="report_type" class="glass-select">
            <option value="standard">标准行业报告</option>
            <option value="literature_review">文献综述报告</option>
            <option value="industry_research">行业研究报告</option>
            <option value="popular_science">科普知识报告</option>
          </select>
        </div>

        <!-- 模型选择 -->
        <div>
          <label class="block text-white/80 text-sm font-medium mb-2">模型选择（选填）</label>
          <select name="llm_model" class="glass-select">
            <option value="deepseek-chat">DeepSeek Chat</option>
            <option value="deepseek-reasoner">DeepSeek Reasoner</option>
          </select>
        </div>

        <!-- 简历上传（可选） -->
        <div>
          <label class="block text-white/80 text-sm font-medium mb-2">上传简历（选填）</label>
          <input type="file" name="resume_file" accept=".txt,.pdf,.doc,.docx,.xlsx,.xls,.jpg,.jpeg,.png" class="glass-input" />
        </div>

        <!-- 排序方式 -->
        <div>
          <label class="block text-white/80 text-sm font-medium mb-2">排序方式（选填）</label>
          <select name="sort_by" class="glass-select">
            <option value="relevance">按相关性排序</option>
            <option value="submittedDate">按提交日期排序</option>
            <option value="lastUpdatedDate">按更新日期排序</option>
          </select>
        </div>

        <!-- 时间过滤 -->
        <div>
          <label class="block text-white/80 text-sm font-medium mb-2">时间过滤（选填）</label>
          <div class="flex items-center space-x-4 mb-2">
            <div class="flex items-center">
              <input type="radio" id="time_recent" name="time_filter" value="recent" checked class="mr-2">
              <label for="time_recent" class="text-white/80">最近</label>
            </div>
            <div class="flex items-center">
              <input type="radio" id="time_custom" name="time_filter" value="custom" class="mr-2">
              <label for="time_custom" class="text-white/80">自定义日期范围</label>
            </div>
          </div>
          
          <!-- 最近时间范围 -->
          <div id="recent_time_container">
            <select name="day" class="glass-select">
              <option value="7">最近7天</option>
              <option value="30">最近30天</option>
              <option value="90">最近3个月</option>
              <option value="180">最近6个月</option>
              <option value="365">最近1年</option>
            </select>
          </div>
          
          <!-- 自定义日期范围 -->
          <div id="custom_time_container" class="hidden grid grid-cols-2 gap-4 mt-2">
            <div>
              <label class="block text-white/80 text-xs mb-1">开始日期</label>
              <input type="date" name="time_from" class="glass-input" />
            </div>
            <div>
              <label class="block text-white/80 text-xs mb-1">结束日期</label>
              <input type="date" name="time_to" class="glass-input" />
            </div>
          </div>
        </div>

        <!-- 论文类别 -->
        <div>
          <label class="block text-white/80 text-sm font-medium mb-2">论文类别（选填，多个类别用逗号分隔）</label>
          <input name="categories" placeholder="例如：cs.AI,cs.CL,cs.CV（选填）" class="glass-input" />
          <p class="text-white/60 text-xs mt-1">常见类别: cs.AI (人工智能), cs.CL (计算语言学), cs.CV (计算机视觉), cs.LG (机器学习), cs.RO (机器人)</p>
        </div>

        <!-- 文献数量 -->
        <div>
          <label class="block text-white/80 text-sm font-medium mb-2">参考文献数量（选填）</label>
          <input type="number" name="num_papers" value="15" min="1" max="30" 
                 class="glass-input" placeholder="建议 5-20 篇（选填）" />
        </div>

        <!-- 平台选择 -->
        <div>
          <label class="block text-white/80 text-sm font-medium mb-2">搜索平台</label>
          <select name="platform" class="glass-select">
            <option value="arXiv论文">arXiv论文</option>
            <option value="谷歌学术">谷歌学术</option>
            <option value="混合搜索">混合搜索 (arXiv + 谷歌学术)</option>
            <option value="综合资讯">综合资讯</option>
            <option value="全平台">全平台搜索</option>
          </select>
        </div>

        
        <!-- 生成按钮 -->
        <div class="pt-4">
          <button type="submit" class="generate-btn" disabled>
            <i class="fas fa-rocket mr-3"></i>
            <span>开始生成智能报告</span>
          </button>
        </div>
      </form>
    </div>

    <!-- 报告输出区域 -->
    <div class="glass-card p-8 min-h-96 fade-in">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-semibold text-white flex items-center">
          <i class="fas fa-file-alt mr-3 text-blue-400"></i>
          报告输出
        </h3>
        <div class="flex space-x-3">
          <button class="p-2 text-white/60 hover:text-blue-400 transition-colors" title="复制报告">
            <i class="fas fa-copy"></i>
          </button>
          <button class="p-2 text-white/60 hover:text-green-400 transition-colors" title="下载报告">
            <i class="fas fa-download"></i>
          </button>
          <button class="p-2 text-white/60 hover:text-purple-400 transition-colors" title="分享报告">
            <i class="fas fa-share-alt"></i>
          </button>
        </div>
      </div>

      <!-- 报告内容区 -->
      <div id="reportContent" class="report-content typewriter">
        <div class="text-center py-16">
          <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-full flex items-center justify-center border-2 border-blue-500/30">
            <i class="fas fa-file-text text-4xl text-blue-400"></i>
          </div>
          <h3 class="text-xl font-medium text-white mb-3">等待生成报告</h3>
          <p class="text-white/60 mb-6">请填写完整信息后点击生成按钮</p>
          <div class="flex justify-center space-x-6 text-sm text-white/50">
            <div class="flex items-center">
              <i class="fas fa-check-circle mr-2 text-green-400"></i>
              AI智能分析
            </div>
            <div class="flex items-center">
              <i class="fas fa-check-circle mr-2 text-green-400"></i>
              实时进度追踪
            </div>
            <div class="flex items-center">
              <i class="fas fa-check-circle mr-2 text-green-400"></i>
              专业报告格式
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 进度模态框 -->
  <div id="progressModal" class="fixed bottom-4 right-4 w-120 progress-modal rounded-2xl shadow-xl z-50 hidden">
    <div class="progress-card p-8 w-96 max-w-[90vw]">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4 pulse">
          <i class="fas fa-cog spin text-white text-2xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-white mb-2">正在生成报告...</h3>
        <p id="progressMsg" class="text-white/70">正在初始化系统</p>
      </div>
      
      <div class="space-y-4">
        <div class="w-full h-3 bg-black/30 rounded-full overflow-hidden">
          <div id="progressBar" class="h-full progress-bar" style="width:0%"></div>
        </div>
        
        <div class="flex justify-between text-sm text-white/60">
          <span>处理进度</span>
          <span id="progressPercent">0%</span>
        </div>
      </div>
      
      <div class="mt-6 text-center text-sm text-white/50">
        <i class="fas fa-info-circle mr-2"></i>
        AI正在为您分析和整理知识内容，请稍候...
      </div>
    </div>
  </div>

  <!-- JavaScript 逻辑 -->
  <script type="module">
    import { createParser } from 'https://cdn.jsdelivr.net/npm/eventsource-parser@3.0.2/+esm';

    // 初始化 Mermaid
    mermaid.initialize({ 
      theme: 'dark',
      themeVariables: {
        primaryColor: '#667eea',
        primaryTextColor: '#fff',
        primaryBorderColor: '#764ba2',
        lineColor: '#667eea',
        background: '#1a1a2e'
      },
      startOnLoad: true
    });

    // 增强Markdown渲染配置
    marked.setOptions({
      renderer: new marked.Renderer(),
      highlight: function(code, lang) {
        return code;
      },
      pedantic: false,
      gfm: true,
      breaks: false,
      sanitize: false,
      smartypants: false,
      xhtml: false
    });

    // 保存报告生成状态，用于页面切换后恢复
    let reportState = {
      generating: false,
      fullMarkdown: '',    // 存储完整的Markdown文本
      currentStep: 0,
      totalSteps: 0,
      reader: null,
      controller: null,
      eventSource: null
    };

    const form = document.getElementById('knowledgeForm');
    const reportEl = document.getElementById('reportContent');
    
    // 页面可见性变化事件处理
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible' && reportState.generating) {
        // 页面重新变为可见，如果正在生成报告，渲染当前积累的内容
        renderMarkdown(reportState.fullMarkdown);
      }
    });

    // 处理时间过滤器切换
    const timeRecentRadio = document.getElementById('time_recent');
    const timeCustomRadio = document.getElementById('time_custom');
    const recentTimeContainer = document.getElementById('recent_time_container');
    const customTimeContainer = document.getElementById('custom_time_container');
    
    timeRecentRadio.addEventListener('change', function() {
      if (this.checked) {
        recentTimeContainer.classList.remove('hidden');
        customTimeContainer.classList.add('hidden');
      }
    });
    
    timeCustomRadio.addEventListener('change', function() {
      if (this.checked) {
        recentTimeContainer.classList.add('hidden');
        customTimeContainer.classList.remove('hidden');
      }
    });

    // 设置默认日期
    const setDefaultDates = () => {
      const today = new Date();
      const oneMonthAgo = new Date();
      oneMonthAgo.setMonth(today.getMonth() - 1);
      
      const timeFromInput = document.querySelector('input[name="time_from"]');
      const timeToInput = document.querySelector('input[name="time_to"]');
      
      if (timeFromInput && timeToInput) {
        timeFromInput.value = oneMonthAgo.toISOString().split('T')[0];
        timeToInput.value = today.toISOString().split('T')[0];
      }
    };
    
    // 页面加载时设置默认日期
    document.addEventListener('DOMContentLoaded', setDefaultDates);

    // 健康检查并调整平台可用性
    async function healthCheck() {
      try {
        const resp = await fetch('/api/health');
        const data = await resp.json();
        if (!data.ok) return;
        const platformSelect = form.querySelector('select[name="platform"]');
        const options = platformSelect.options;
        const serperOk = !!data.serper;
        // 定义需要 Serper 的平台值
        const needSerper = new Set(['谷歌学术','混合搜索','综合资讯','全平台']);
        let changed = false;
        for (let i = 0; i < options.length; i++) {
          const opt = options[i];
          if (needSerper.has(opt.value)) {
            opt.disabled = !serperOk;
          }
        }
        if (!serperOk && needSerper.has(platformSelect.value)) {
          platformSelect.value = 'arXiv论文';
          changed = true;
        }
        if (!serperOk) {
          showToast('检测到缺少 SERPER_API_KEY，已禁用谷歌相关平台，默认使用 arXiv。', 'error');
        } else if (changed) {
          showToast('平台已切换为 arXiv。', 'info');
        }
      } catch (e) {
        // 忽略健康检查失败
      }
    }
    healthCheck();

    // 渲染Markdown内容
    function renderMarkdown(markdownText) {
      try {
        let safeMarkdown = (markdownText || '')
          .replace(/<script/gi, '&lt;script')
          .replace(/<\/script>/gi, '&lt;/script&gt;')
          .replace(/<iframe/gi, '&lt;iframe')
          .replace(/<\/iframe>/gi, '&lt;/iframe&gt;')
          // 移除可能误注入的页面辅助函数与变量片段
          .replace(/function\s+getCurrentUser\s*\([^)]*\)\s*\{[\s\S]{0,2000}?\}/gi, '')
          .replace(/const\s+currentUser\s*=\s*getCurrentUser\(\);[\s\S]{0,2000}?$/gmi, '');
        // 基于关键词行过滤，避免UI脚本片段渲染
        const blockedTokens = [
          'function getCurrentUser', 'const currentUser', 'current-user-json',
          'guestBadge', 'logoutBtn', 'authLink', 'userNameLabel',
          "form.querySelector('input[name=\"email\"]')",
          'getElementById(', 'logout', 'applyUserUI'
        ];
        safeMarkdown = safeMarkdown
          .split('\n')
          .filter(line => !blockedTokens.some(t => line.includes(t)))
          .filter(line => !/getElementById\s*\(/.test(line))
          .filter(line => !/applyUserUI\s*\(/.test(line))
          .join('\n');
        reportEl.innerHTML = marked.parse(safeMarkdown);
        
        // 运行代码块高亮和图表渲染
        setTimeout(() => {
          // 检查当前DOM内是否有mermaid图表
          document.querySelectorAll('.mermaid').forEach(el => {
            if (!el.hasAttribute('data-processed')) {
              try {
                mermaid.init(undefined, el);
              } catch (err) {
                console.error('Mermaid chart rendering error:', err);
              }
            }
          });
        }, 100);
        
      } catch (error) {
        console.error('Markdown渲染错误:', error);
      }
    }

    const progressModal = document.getElementById('progressModal');
    const barEl = document.getElementById('progressBar');
    const msgEl = document.getElementById('progressMsg');
    const percentEl = document.getElementById('progressPercent');

    // 表单验证
    const submitBtn = form.querySelector('button[type="submit"]');
    const contentInput = form.querySelector('input[name="content_type"]');
    
    function validateForm() {
      const isValid = contentInput.value.trim().length > 0;
      submitBtn.disabled = !isValid;
      
      if (isValid) {
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
      } else {
        submitBtn.style.opacity = '0.6';
        submitBtn.style.cursor = 'not-allowed';
      }
    }
    
    contentInput.addEventListener('input', validateForm);
    validateForm();

    // 表单提交处理
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      
      // 如果已经在生成过程中，阻止再次提交
      if (reportState.generating) {
        showToast('报告正在生成中，请稍候...', 'info');
        return;
      }
      
      reportEl.innerHTML = `
        <div class="text-center py-16">
          <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
            <i class="fas fa-cog spin text-white text-xl"></i>
          </div>
          <p class="text-white/70">正在生成您的专属报告...</p>
        </div>
      `;
      
      showProgress('正在初始化处理流程...', 0);

      // 重置报告状态
      reportState = {
        generating: true,
        fullMarkdown: '',
        currentStep: 0,
        totalSteps: 0,
        reader: null,
        controller: null
      };

      try {
        reportState.controller = new AbortController();
        const fd = new FormData(form);
        
        const resp = await fetch('/process', { method: 'POST', body: fd, signal: reportState.controller.signal });
        
        if (!resp.ok) throw new Error('服务器响应错误');

        reportState.reader = resp.body.getReader();
        const parser = createParser({
          onEvent(evt) {
            switch (evt.event) {
              case 'progress':
                const progressData = JSON.parse(evt.data);
                reportState.currentStep = progressData.step;
                reportState.totalSteps = progressData.total_steps;
                updateProgress(progressData);
                break;
              case 'report_start':
                reportState.fullMarkdown = '';
                reportEl.textContent = '';
                break;
              case 'report_chunk':
                // 累积Markdown内容
                reportState.fullMarkdown += evt.data;
                // 实时渲染Markdown
                renderMarkdown(reportState.fullMarkdown);
                // 保持滚动到底部
                reportEl.scrollTop = reportEl.scrollHeight;
                break;
              case 'error':
                reportState.generating = false;
                hideProgress();
                showError(JSON.parse(evt.data).message);
                break;
              case 'complete':
                reportState.generating = false;
                hideProgress();
                // 最终渲染
                renderMarkdown(reportState.fullMarkdown);
                showToast('报告生成完成！', 'success');
                break;
            }
          }
        });

        while (true) {
          const { value, done } = await reportState.reader.read();
          if (done) break;
          parser.feed(new TextDecoder().decode(value));
        }
      } catch (err) {
        // 判断是否为用户主动中止请求
        if (err.name === 'AbortError') {
          showToast('已取消报告生成', 'info');
        } else {
          hideProgress();
          showError(err.message || '网络连接失败，请重试');
          console.error('处理错误:', err);
        }
        reportState.generating = false;
      }
    });

    // 进度控制
    function showProgress(text, ratio) {
      msgEl.textContent = text;
      const percentage = Math.round(ratio * 100);
      barEl.style.width = `${percentage}%`;
      percentEl.textContent = `${percentage}%`;
      progressModal.classList.remove('hidden');
    }

    function updateProgress({ step, total_steps, message }) {
      showProgress(message, step / total_steps);
    }

    function hideProgress() {
      progressModal.classList.add('hidden');
    }

    // Toast 通知
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-2"></i>
          ${message}
        </div>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, type === 'error' ? 5000 : 3000);
    }

    // 错误处理
    function showError(msg) {
      showToast(`生成失败：${msg}`, 'error');
      
      reportEl.innerHTML = `
        <div class="text-center py-16">
          <div class="w-24 h-24 mx-auto mb-6 bg-red-500/20 rounded-full flex items-center justify-center border-2 border-red-500/30">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400"></i>
          </div>
          <h3 class="text-xl font-medium mb-2 text-red-400">生成失败</h3>
          <p class="text-white/60 mb-6">${msg}</p>
          <button onclick="location.reload()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
            <i class="fas fa-redo mr-2"></i>重新尝试
          </button>
        </div>
      `;
    }
    
    // 注入当前用户（通过 JSON 脚本，避免模板插值导致的JS解析报错）
    // 见页面底部的 <script id="current-user-json" type="application/json"> ... </script>
    function getCurrentUser(){
      try { const el = document.getElementById('current-user-json');
        return el ? JSON.parse(el.textContent) : null; } catch(e){ return null; }
    }
    function applyUserUI(){
      try {
        const currentUser = getCurrentUser();
        const guestBadge = document.getElementById('guestBadge');
        const logoutBtn = document.getElementById('logoutBtn');
        const authLink = document.getElementById('authLink');
        const userNameLabel = document.getElementById('userNameLabel');
        const adminEntry = document.getElementById('adminEntry');
        const adminBadge = document.getElementById('adminBadge');
        if (currentUser){
          const emailInput = document.querySelector('#knowledgeForm input[name="email"]');
          if (currentUser.email && emailInput) emailInput.value = currentUser.email;
          if (logoutBtn) logoutBtn.classList.remove('hidden');
          if (guestBadge) guestBadge.classList.add('hidden');
          if (authLink) authLink.classList.add('hidden');
          if (userNameLabel){ userNameLabel.textContent = currentUser.username; userNameLabel.classList.remove('hidden'); }
          if (currentUser.is_admin){ if (adminEntry) adminEntry.classList.remove('hidden'); if (adminBadge) adminBadge.classList.remove('hidden'); }
          if (logoutBtn) logoutBtn.onclick = async ()=>{ await fetch('/auth/logout', { method:'POST' }); location.reload(); };
        } else {
          if (guestBadge) guestBadge.classList.remove('hidden');
          if (authLink) authLink.classList.remove('hidden');
          if (userNameLabel) userNameLabel.classList.add('hidden');
          if (logoutBtn) logoutBtn.classList.add('hidden');
          if (adminEntry) adminEntry.classList.add('hidden');
          if (adminBadge) adminBadge.classList.add('hidden');
        }
      } catch(e){}
    }
    document.addEventListener('DOMContentLoaded', applyUserUI);
    
  </script>
  <script id="current-user-json" type="application/json">{{ current_user | tojson | safe if current_user else '' }}</script>
</body>
</html>